name: ðŸ³ Docker Deploy to psytest.su

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/psyweb

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ”‘ Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ—ï¸ Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ðŸ—ï¸ Build and push Frontend image
      uses: docker/build-push-action@v5
        with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ðŸ”§ Setup SSH
      if: github.ref == 'refs/heads/main'
        run: |
        echo "ðŸ”§ Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SSH config Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
        cat > ~/.ssh/config << 'EOF'
        Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            GlobalKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 10
            ServerAliveCountMax 3
            TCPKeepAlive yes
            AddressFamily inet
            PreferredAuthentications publickey
            PubkeyAuthentication yes
            PasswordAuthentication no
            BatchMode yes
        EOF
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€Ð°
        echo "ðŸ” Testing server connectivity..."
        ping -c 3 ${{ secrets.SERVER_HOST }} || echo "âš ï¸ Ping failed, but continuing..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ SSH Ð¿Ð¾Ñ€Ñ‚
        echo "ðŸ” Testing SSH port 22..."
        nc -zv ${{ secrets.SERVER_HOST }} 22 || echo "âš ï¸ SSH port 22 not accessible"
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ñ…Ð¾ÑÑ‚Ð° Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ IPv4
        echo "ðŸ” Adding host key..."
        ssh-keyscan -H -4 -p 22 ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "âš ï¸ Could not add host key"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ known_hosts
        echo "ðŸ” Known hosts:"
        cat ~/.ssh/known_hosts | grep ${{ secrets.SERVER_HOST }} || echo "No host key found"
        
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ SSH ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
        echo "ðŸ” Testing SSH connection with verbose output..."
        ssh -vvv -o ConnectTimeout=30 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -o TCPKeepAlive=yes -o AddressFamily=inet -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o PasswordAuthentication=no -o BatchMode=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'" || echo "âš ï¸ SSH test failed, but continuing with deployment"
        
    - name: ðŸš€ Deploy to production server
      if: github.ref == 'refs/heads/main'
        run: |
        echo "ðŸš€ Deploying Docker containers to ${{ secrets.SERVER_HOST }}..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "âŒ SERVER_HOST secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.SERVER_USER }}" ]; then
          echo "âŒ SERVER_USER secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret is not set!"
          exit 1
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
        mkdir -p deploy-temp
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Docker Ñ„Ð°Ð¹Ð»Ñ‹
        cp docker-compose.yml deploy-temp/ 2>/dev/null || true
        cp docker-compose.prod.yml deploy-temp/ 2>/dev/null || true
        cp nginx.conf deploy-temp/ 2>/dev/null || true
        cp deploy.sh deploy-temp/ 2>/dev/null || true
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ production docker-compose
        cat > deploy-temp/docker-compose.prod.yml << 'EOF'
        services:
          backend:
            image: ghcr.io/${{ github.repository_owner }}/psyweb-backend:latest
            container_name: psyweb-backend-prod
            ports:
              - "8000:8000"
            environment:
              - DEBUG=False
              - DJANGO_SETTINGS_MODULE=mindjourney.settings
              - ALLOWED_HOSTS=${{ secrets.SERVER_HOST }}
            volumes:
              - backend_static:/app/staticfiles
              - backend_media:/app/media
            networks:
              - psyweb-network
            restart: unless-stopped

          frontend:
            image: ghcr.io/${{ github.repository_owner }}/psyweb-frontend:latest
            container_name: psyweb-frontend-prod
            ports:
              - "3000:3000"
            environment:
              - REACT_APP_API_URL=http://${{ secrets.SERVER_HOST }}:8000/api
            depends_on:
              - backend
            networks:
              - psyweb-network
            restart: unless-stopped

          nginx:
            image: nginx:alpine
            container_name: psyweb-nginx-prod
            ports:
              - "80:80"
              - "443:443"
            volumes:
              - ./nginx.conf:/etc/nginx/nginx.conf
              - backend_static:/var/www/static
              - backend_media:/var/www/media
            depends_on:
              - backend
              - frontend
            networks:
              - psyweb-network
            restart: unless-stopped

        volumes:
          backend_static:
          backend_media:

        networks:
          psyweb-network:
            driver: bridge
        EOF
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÐµÐ¹
        cat > deploy-temp/deploy-docker.sh << 'EOF'
        #!/bin/bash
        echo "ðŸ³ Starting Docker deployment on ${{ secrets.SERVER_HOST }}..."
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        echo "ðŸ›‘ Stopping old containers..."
        docker-compose -f docker-compose.prod.yml down || true
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ)
        echo "ðŸ§¹ Cleaning up unused images..."
        docker image prune -f
        
        # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
        echo "ðŸ”‘ Logging into GitHub Container Registry..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
        echo "ðŸ” Checking image availability..."
        docker pull ghcr.io/${{ github.repository_owner }}/psyweb-backend:latest
        docker pull ghcr.io/${{ github.repository_owner }}/psyweb-frontend:latest
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        echo "ðŸš€ Starting new containers..."
        docker-compose -f docker-compose.prod.yml up -d
        
        # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        echo "â³ Waiting for containers to start..."
        sleep 10
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
        echo "ðŸ“Š Container status:"
        docker-compose -f docker-compose.prod.yml ps
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸
        echo "ðŸ“‹ Recent logs:"
        docker-compose -f docker-compose.prod.yml logs --tail=20
        
        echo "âœ… Docker deployment completed!"
        EOF
        
        chmod +x deploy-temp/deploy-docker.sh
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
        tar -czf psyweb-docker-deploy.tar.gz -C deploy-temp .
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
        rm -rf deploy-temp
        
        # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
        echo "ðŸ“¤ Uploading Docker deployment files..."
        echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
        echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ scp Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸
        echo "ðŸ“¤ Uploading deployment files via SCP..."
        if ! scp -o ConnectTimeout=60 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -o TCPKeepAlive=yes -o AddressFamily=inet -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o PasswordAuthentication=no -o BatchMode=yes psyweb-docker-deploy.tar.gz "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/"; then
          echo "âš ï¸ SCP failed, trying rsync..."
          rsync -avz -e "ssh -o ConnectTimeout=60 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -o TCPKeepAlive=yes -o AddressFamily=inet -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o PasswordAuthentication=no -o BatchMode=yes" psyweb-docker-deploy.tar.gz "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/"
        fi
        
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        echo "ðŸ”§ Deploying Docker containers on server..."
        ssh -o ConnectTimeout=60 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -o TCPKeepAlive=yes -o AddressFamily=inet -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o PasswordAuthentication=no -o BatchMode=yes "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << 'EOF'
          echo "Starting Docker deployment on ${{ secrets.SERVER_HOST }}..."
          cd /opt/psyweb || mkdir -p /opt/psyweb && cd /opt/psyweb
          
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´ÐµÐ¿Ð»Ð¾Ñ
          echo "ðŸ“¦ Extracting deployment files..."
          tar -xzf /tmp/psyweb-docker-deploy.tar.gz
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
          echo "ðŸš€ Running deployment script..."
          chmod +x deploy-docker.sh
          ./deploy-docker.sh
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          rm -f /tmp/psyweb-docker-deploy.tar.gz
          
          echo "âœ… Docker deployment completed on ${{ secrets.SERVER_HOST }}!"
        EOF
        
    - name: ðŸ“Š Deployment success
      if: github.ref == 'refs/heads/main'
        run: |
        echo "âœ… Docker deployment completed successfully!"
          echo "ðŸŒ Application is live at: http://${{ secrets.SERVER_HOST }}"
          echo "ðŸ”— Frontend: http://${{ secrets.SERVER_HOST }}:3000"
          echo "ðŸ”— Backend API: http://${{ secrets.SERVER_HOST }}:8000"
          echo "ðŸ”— Admin: http://${{ secrets.SERVER_HOST }}:8000/admin"
name: ðŸ³ Docker Deploy to psytest.su

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/psyweb

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ”‘ Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ—ï¸ Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ðŸ—ï¸ Build and push Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: ðŸ”§ Setup SSH
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸ”§ Setting up SSH..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸš€ Deploy to production server
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ðŸš€ Deploying Docker containers to psytest.su..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
        mkdir -p deploy-temp
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Docker Ñ„Ð°Ð¹Ð»Ñ‹
        cp docker-compose.yml deploy-temp/
        cp docker-compose.prod.yml deploy-temp/ 2>/dev/null || true
        cp nginx.conf deploy-temp/ 2>/dev/null || true
        cp deploy.sh deploy-temp/ 2>/dev/null || true
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ production docker-compose
        cat > deploy-temp/docker-compose.prod.yml << 'EOF'
        services:
          backend:
            image: ghcr.io/${{ github.repository_owner }}/psyweb-backend:latest
            container_name: psyweb-backend-prod
            ports:
              - "8000:8000"
            environment:
              - DEBUG=False
              - DJANGO_SETTINGS_MODULE=mindjourney.settings
              - ALLOWED_HOSTS=psytest.su,www.psytest.su
            volumes:
              - backend_static:/app/staticfiles
              - backend_media:/app/media
            networks:
              - psyweb-network
            restart: unless-stopped

          frontend:
            image: ghcr.io/${{ github.repository_owner }}/psyweb-frontend:latest
            container_name: psyweb-frontend-prod
            ports:
              - "3000:3000"
            environment:
              - REACT_APP_API_URL=https://psytest.su:8000/api
            depends_on:
              - backend
            networks:
              - psyweb-network
            restart: unless-stopped

          nginx:
            image: nginx:alpine
            container_name: psyweb-nginx-prod
            ports:
              - "80:80"
              - "443:443"
            volumes:
              - ./nginx.conf:/etc/nginx/nginx.conf
              - backend_static:/var/www/static
              - backend_media:/var/www/media
            depends_on:
              - backend
              - frontend
            networks:
              - psyweb-network
            restart: unless-stopped

        volumes:
          backend_static:
          backend_media:

        networks:
          psyweb-network:
            driver: bridge
        EOF
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ
        cat > deploy-temp/deploy-docker.sh << 'EOF'
        #!/bin/bash
        echo "ðŸ³ Starting Docker deployment on psytest.su..."
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        docker-compose -f docker-compose.prod.yml down || true
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
        docker image prune -f
        
        # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ Ð² GitHub Container Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
        docker-compose -f docker-compose.prod.yml up -d --pull always
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
        docker-compose -f docker-compose.prod.yml ps
        
        echo "âœ… Docker deployment completed!"
        EOF
        
        chmod +x deploy-temp/deploy-docker.sh
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
        tar -czf psyweb-docker-deploy.tar.gz -C deploy-temp .
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¿Ð°Ð¿ÐºÑƒ
        rm -rf deploy-temp
        
        # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
        echo "ðŸ“¤ Uploading Docker deployment files..."
        scp -o ConnectTimeout=30 psyweb-docker-deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
        
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        echo "ðŸ”§ Deploying Docker containers on server..."
        ssh -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "Starting Docker deployment on psytest.su..."
          cd /opt/psyweb || mkdir -p /opt/psyweb && cd /opt/psyweb
          
          # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´ÐµÐ¿Ð»Ð¾Ñ
          tar -xzf /tmp/psyweb-docker-deploy.tar.gz
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
          chmod +x deploy-docker.sh
          ./deploy-docker.sh
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          rm -f /tmp/psyweb-docker-deploy.tar.gz
          
          echo "âœ… Docker deployment completed on psytest.su!"
        EOF
        
    - name: ðŸ“Š Deployment success
      if: github.ref == 'refs/heads/main'
      run: |
        echo "âœ… Docker deployment completed successfully!"
        echo "ðŸŒ Application is live at: https://psytest.su"
        echo "ðŸ”— Frontend: https://psytest.su:3000"
        echo "ðŸ”— Backend API: https://psytest.su:8000"
        echo "ðŸ”— Admin: https://psytest.su:8000/admin"
